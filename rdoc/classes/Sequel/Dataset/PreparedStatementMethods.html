<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html lang='en'>
  <head>
    <title>Sequel::Dataset::PreparedStatementMethods</title>
    <meta content='text/html; charset=UTF-8' http-equiv='Content-Type'>
    <link href='../../../css/style.css' media='screen' rel='stylesheet' type='text/css'>
    <script type='text/javascript'>
      //<![CDATA[
        function popupCode(url) {
          window.open(url, "Code", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=150,width=400")
        }
        
        function toggleCode(id) {
          var code = document.getElementById(id)
        
          code.style.display = code.style.display != 'block' ? 'block' : 'none'
          return true
        }
        
        // Make codeblocks hidden by default
        document.writeln('<' + 'style type="text/css">.method .source pre { display: none }<\/style>')
      //]]>
    </script>
  </head>
  <body class='page'>
    <div class='class' id='wrapper'>
      <div class='header'>
        <h1 class='name'>
          <span class='type'>module</span>
          Sequel::Dataset::PreparedStatementMethods
        </h1>
        <ol class='paths'>
          <li>
            <a target="docwin" href="../../../files/lib/sequel/dataset/prepared_statements_rb.html">lib/sequel/dataset/prepared_statements.rb</a>
          </li>
        </ol>
        <div class='parent'>
          Parent:
          <strong><a target="docwin" href="../Dataset.html">Dataset</a></strong>
        </div>
      </div>
      <div id='content'>
        <div id='text'>
          <div id='description'>
            
            <p>Backbone of the prepared statement support.  Grafts bind variable support
            into datasets by hijacking literal and using placeholders. By default,
            emulates prepared statements and bind variables by taking the hash of bind
            variables and directly substituting them into the query, which works on all
            databases, as it is no different from using the dataset without bind
            variables.</p>
          </div>
          <div id='method-list'>
            <h2>Methods</h2>
            <h3>Public Instance</h3>
            <ol>
              <li><a target="docwin" href="#method-i-call">call</a></li>
              <li><a target="docwin" href="#method-i-columns">columns</a></li>
              <li><a target="docwin" href="#method-i-inspect">inspect</a></li>
              <li><a target="docwin" href="#method-i-literal_symbol_append">literal_symbol_append</a></li>
              <li><a target="docwin" href="#attribute-i-log_sql">log_sql</a></li>
              <li><a target="docwin" href="#attribute-i-orig_dataset">orig_dataset</a></li>
              <li><a target="docwin" href="#attribute-i-prepared_args">prepared_args</a></li>
              <li><a target="docwin" href="#attribute-i-prepared_modify_values">prepared_modify_values</a></li>
              <li><a target="docwin" href="#method-i-prepared_sql">prepared_sql</a></li>
              <li><a target="docwin" href="#attribute-i-prepared_type">prepared_type</a></li>
            </ol>
            <h3>Protected Instance</h3>
            <ol>
              <li><a target="docwin" href="#method-i-run">run</a></li>
            </ol>
          </div>
          <div id='context'>
          </div>
          <div id='section'>
            <div id='constants-list'>
              <h2>Constants</h2>
              <div class='name-list'>
                <table summary='Constants'>
                  <tr class='top-aligned-row context-row'>
                    <td class='context-item-name'>PLACEHOLDER_RE</td>
                    <td>=</td>
                    <td class='context-item-value'>/\A\$(.*)\z/</td>
                    <td>&nbsp;</td>
                    <td class='context-item-desc'></td>
                  </tr>
                </table>
              </div>
            </div>
            <div id='attribute-list'>
              <h2 class='section-bar'>Attributes</h2>
              <div class='name-list'>
                <table>
                  <tr class='top-aligned-row context-row'>
                    <td class='context-item-name'>
                      <a name='attribute-i-log_sql'>log_sql</a>
                    </td>
                    <td class='context-item-value'>[RW]</td>
                    <td class='context-item-desc'>
                      
                      <p>Whether to log the full <a href="../SQL.html">SQL</a> query.  By default,
                      just the prepared statement name is generally logged on adapters that
                      support native prepared statements.</p>
                    </td>
                  </tr>
                  <tr class='top-aligned-row context-row'>
                    <td class='context-item-name'>
                      <a name='attribute-i-orig_dataset'>orig_dataset</a>
                    </td>
                    <td class='context-item-value'>[RW]</td>
                    <td class='context-item-desc'>
                      
                      <p>The dataset that created this prepared statement.</p>
                    </td>
                  </tr>
                  <tr class='top-aligned-row context-row'>
                    <td class='context-item-name'>
                      <a name='attribute-i-prepared_args'>prepared_args</a>
                    </td>
                    <td class='context-item-value'>[RW]</td>
                    <td class='context-item-desc'>
                      
                      <p>The array/hash of bound variable placeholder names.</p>
                    </td>
                  </tr>
                  <tr class='top-aligned-row context-row'>
                    <td class='context-item-name'>
                      <a name='attribute-i-prepared_modify_values'>prepared_modify_values</a>
                    </td>
                    <td class='context-item-value'>[RW]</td>
                    <td class='context-item-desc'>
                      
                      <p>The argument to supply to insert and update, which may use placeholders
                      specified by <a
                      href="PreparedStatementMethods.html#attribute-i-prepared_args">#prepared_args</a></p>
                    </td>
                  </tr>
                  <tr class='top-aligned-row context-row'>
                    <td class='context-item-name'>
                      <a name='attribute-i-prepared_type'>prepared_type</a>
                    </td>
                    <td class='context-item-value'>[RW]</td>
                    <td class='context-item-desc'>
                      
                      <p>The type of prepared statement, should be one of :select, :first, :insert,
                      :update, or :delete</p>
                    </td>
                  </tr>
                </table>
              </div>
            </div>
            <div id='methods'>
              <h2>Public Instance methods</h2>
              <div class='method public-instance' id='method-method-i-call'>
                <a name='method-i-call'></a>
                <div class='synopsis'>
                  <span class='name'>call</span>
                  <span class='arguments'>(bind_vars={}, &block)</span>
                </div>
                <div class='description'>
                  
                  <p>Sets the <a
                  href="PreparedStatementMethods.html#attribute-i-prepared_args">#prepared_args</a>
                  to the given hash and runs the prepared statement.</p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('method-i-call-source'); return false">
                    [show source]
                  </a>
                  <pre id='method-i-call-source'><span class="ruby-comment"># File lib/sequel/dataset/prepared_statements.rb, line 69</span>&#x000A;<span class="ruby-keyword">def</span> <span class="ruby-identifier">call</span>(<span class="ruby-identifier">bind_vars</span>={}, &amp;<span class="ruby-identifier">block</span>)&#x000A;  <span class="ruby-identifier">bind</span>(<span class="ruby-identifier">bind_vars</span>).<span class="ruby-identifier">run</span>(&amp;<span class="ruby-identifier">block</span>)&#x000A;<span class="ruby-keyword">end</span></pre>
                </div>
              </div>
              <div class='method public-instance' id='method-method-i-columns'>
                <a name='method-i-columns'></a>
                <div class='synopsis'>
                  <span class='name'>columns</span>
                  <span class='arguments'>()</span>
                </div>
                <div class='description'>
                  
                  <p>Send the columns to the original dataset, as calling it on the prepared
                  statement can cause problems.</p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('method-i-columns-source'); return false">
                    [show source]
                  </a>
                  <pre id='method-i-columns-source'><span class="ruby-comment"># File lib/sequel/dataset/prepared_statements.rb, line 75</span>&#x000A;<span class="ruby-keyword">def</span> <span class="ruby-identifier">columns</span>&#x000A;  <span class="ruby-identifier">orig_dataset</span>.<span class="ruby-identifier">columns</span>&#x000A;<span class="ruby-keyword">end</span></pre>
                </div>
              </div>
              <div class='method public-instance' id='method-method-i-inspect'>
                <a name='method-i-inspect'></a>
                <div class='synopsis'>
                  <span class='name'>inspect</span>
                  <span class='arguments'>()</span>
                </div>
                <div class='description'>
                  
                  <p>Programmer friendly string showing this is a prepared statement, with the
                  prepared <a href="../SQL.html">SQL</a> it represents (which in general
                  won’t have substituted variables).</p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('method-i-inspect-source'); return false">
                    [show source]
                  </a>
                  <pre id='method-i-inspect-source'><span class="ruby-comment"># File lib/sequel/dataset/prepared_statements.rb, line 120</span>&#x000A;<span class="ruby-keyword">def</span> <span class="ruby-identifier">inspect</span>&#x000A;  <span class="ruby-node">&quot;&lt;#{visible_class_name}/PreparedStatement #{prepared_sql.inspect}&gt;&quot;</span>&#x000A;<span class="ruby-keyword">end</span></pre>
                </div>
              </div>
              <div class='method public-instance' id='method-method-i-literal_symbol_append'>
                <a name='method-i-literal_symbol_append'></a>
                <div class='synopsis'>
                  <span class='name'>literal_symbol_append</span>
                  <span class='arguments'>(sql, v)</span>
                </div>
                <div class='description'>
                  
                  <p>Changes the values of symbols if they start with $ and <a
                  href="PreparedStatementMethods.html#attribute-i-prepared_args">#prepared_args</a>
                  is present.  If so, they are considered placeholders, and they are
                  substituted using prepared_arg.</p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('method-i-literal_symbol_append-source'); return false">
                    [show source]
                  </a>
                  <pre id='method-i-literal_symbol_append-source'><span class="ruby-comment"># File lib/sequel/dataset/prepared_statements.rb, line 104</span>&#x000A;<span class="ruby-keyword">def</span> <span class="ruby-identifier">literal_symbol_append</span>(<span class="ruby-identifier">sql</span>, <span class="ruby-identifier">v</span>)&#x000A;  <span class="ruby-keyword">if</span> <span class="ruby-ivar">@opts</span>[<span class="ruby-value">:bind_vars</span>] <span class="ruby-keyword">and</span> <span class="ruby-identifier">match</span> = <span class="ruby-constant">PLACEHOLDER_RE</span>.<span class="ruby-identifier">match</span>(<span class="ruby-identifier">v</span>.<span class="ruby-identifier">to_s</span>)&#x000A;    <span class="ruby-identifier">s</span> = <span class="ruby-identifier">match</span>[<span class="ruby-value">1</span>].<span class="ruby-identifier">to_sym</span>&#x000A;    <span class="ruby-keyword">if</span> <span class="ruby-identifier">prepared_arg?</span>(<span class="ruby-identifier">s</span>)&#x000A;      <span class="ruby-identifier">literal_append</span>(<span class="ruby-identifier">sql</span>, <span class="ruby-identifier">prepared_arg</span>(<span class="ruby-identifier">s</span>))&#x000A;    <span class="ruby-keyword">else</span>&#x000A;      <span class="ruby-identifier">sql</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">v</span>.<span class="ruby-identifier">to_s</span>&#x000A;    <span class="ruby-keyword">end</span>&#x000A;  <span class="ruby-keyword">else</span>&#x000A;    <span class="ruby-keyword">super</span>&#x000A;  <span class="ruby-keyword">end</span>&#x000A;<span class="ruby-keyword">end</span></pre>
                </div>
              </div>
              <div class='method public-instance' id='method-method-i-prepared_sql'>
                <a name='method-i-prepared_sql'></a>
                <div class='synopsis'>
                  <span class='name'>prepared_sql</span>
                  <span class='arguments'>()</span>
                </div>
                <div class='description'>
                  
                  <p>Returns the <a href="../SQL.html">SQL</a> for the prepared statement,
                  depending on the type of the statement and the prepared_modify_values.</p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('method-i-prepared_sql-source'); return false">
                    [show source]
                  </a>
                  <pre id='method-i-prepared_sql-source'><span class="ruby-comment"># File lib/sequel/dataset/prepared_statements.rb, line 81</span>&#x000A;<span class="ruby-keyword">def</span> <span class="ruby-identifier">prepared_sql</span>&#x000A;  <span class="ruby-keyword">case</span> <span class="ruby-ivar">@prepared_type</span>&#x000A;  <span class="ruby-keyword">when</span> <span class="ruby-value">:select</span>, <span class="ruby-value">:all</span>, <span class="ruby-value">:each</span>&#x000A;    <span class="ruby-comment"># Most common scenario, so listed first.</span>&#x000A;    <span class="ruby-identifier">select_sql</span>&#x000A;  <span class="ruby-keyword">when</span> <span class="ruby-value">:first</span>&#x000A;    <span class="ruby-identifier">clone</span>(<span class="ruby-value">:limit=</span><span class="ruby-operator">&gt;</span><span class="ruby-value">1</span>).<span class="ruby-identifier">select_sql</span>&#x000A;  <span class="ruby-keyword">when</span> <span class="ruby-value">:insert_select</span>&#x000A;    <span class="ruby-identifier">returning</span>.<span class="ruby-identifier">insert_sql</span>(*<span class="ruby-ivar">@prepared_modify_values</span>)&#x000A;  <span class="ruby-keyword">when</span> <span class="ruby-value">:insert</span>&#x000A;    <span class="ruby-identifier">insert_sql</span>(*<span class="ruby-ivar">@prepared_modify_values</span>)&#x000A;  <span class="ruby-keyword">when</span> <span class="ruby-value">:update</span>&#x000A;    <span class="ruby-identifier">update_sql</span>(*<span class="ruby-ivar">@prepared_modify_values</span>)&#x000A;  <span class="ruby-keyword">when</span> <span class="ruby-value">:delete</span>&#x000A;    <span class="ruby-identifier">delete_sql</span>&#x000A;  <span class="ruby-keyword">else</span>&#x000A;    <span class="ruby-identifier">select_sql</span>&#x000A;  <span class="ruby-keyword">end</span>&#x000A;<span class="ruby-keyword">end</span></pre>
                </div>
              </div>
              <h2>Protected Instance methods</h2>
              <div class='method protected-instance' id='method-method-i-run'>
                <a name='method-i-run'></a>
                <div class='synopsis'>
                  <span class='name'>run</span>
                  <span class='arguments'>(&block)</span>
                </div>
                <div class='description'>
                  
                  <p>Run the method based on the type of prepared statement, with :select
                  running all to get all of the rows, and the other types running the method
                  with the same name as the type.</p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('method-i-run-source'); return false">
                    [show source]
                  </a>
                  <pre id='method-i-run-source'><span class="ruby-comment"># File lib/sequel/dataset/prepared_statements.rb, line 129</span>&#x000A;<span class="ruby-keyword">def</span> <span class="ruby-identifier">run</span>(&amp;<span class="ruby-identifier">block</span>)&#x000A;  <span class="ruby-keyword">case</span> <span class="ruby-ivar">@prepared_type</span>&#x000A;  <span class="ruby-keyword">when</span> <span class="ruby-value">:select</span>, <span class="ruby-value">:all</span>&#x000A;    <span class="ruby-comment"># Most common scenario, so listed first</span>&#x000A;    <span class="ruby-identifier">all</span>(&amp;<span class="ruby-identifier">block</span>)&#x000A;  <span class="ruby-keyword">when</span> <span class="ruby-value">:each</span>&#x000A;    <span class="ruby-identifier">each</span>(&amp;<span class="ruby-identifier">block</span>)&#x000A;  <span class="ruby-keyword">when</span> <span class="ruby-value">:insert_select</span>&#x000A;    <span class="ruby-identifier">with_sql</span>(<span class="ruby-identifier">prepared_sql</span>).<span class="ruby-identifier">first</span>&#x000A;  <span class="ruby-keyword">when</span> <span class="ruby-value">:first</span>&#x000A;    <span class="ruby-identifier">first</span>&#x000A;  <span class="ruby-keyword">when</span> <span class="ruby-value">:insert</span>&#x000A;    <span class="ruby-identifier">insert</span>(*<span class="ruby-ivar">@prepared_modify_values</span>)&#x000A;  <span class="ruby-keyword">when</span> <span class="ruby-value">:update</span>&#x000A;    <span class="ruby-identifier">update</span>(*<span class="ruby-ivar">@prepared_modify_values</span>)&#x000A;  <span class="ruby-keyword">when</span> <span class="ruby-value">:delete</span>&#x000A;    <span class="ruby-identifier">delete</span>&#x000A;  <span class="ruby-keyword">when</span> <span class="ruby-constant">Array</span>&#x000A;    <span class="ruby-keyword">case</span> <span class="ruby-ivar">@prepared_type</span>.<span class="ruby-identifier">at</span>(<span class="ruby-value">0</span>)&#x000A;    <span class="ruby-keyword">when</span> <span class="ruby-value">:map</span>, <span class="ruby-value">:to_hash</span>, <span class="ruby-value">:to_hash_groups</span>&#x000A;      <span class="ruby-identifier">send</span>(*<span class="ruby-ivar">@prepared_type</span>, &amp;<span class="ruby-identifier">block</span>) &#x000A;    <span class="ruby-keyword">end</span>&#x000A;  <span class="ruby-keyword">else</span>&#x000A;    <span class="ruby-identifier">all</span>(&amp;<span class="ruby-identifier">block</span>)&#x000A;  <span class="ruby-keyword">end</span>&#x000A;<span class="ruby-keyword">end</span></pre>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div id='footer-push'></div>
    </div>
    <div id='footer'>
      <a target="docwin" href="http://github.com/mislav/hanna/tree/master"><strong>Hanna</strong> RDoc template</a>
    </div>
  </body>
</html>
